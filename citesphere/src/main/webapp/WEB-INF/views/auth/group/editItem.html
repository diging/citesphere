<html layout:decorate="~{layouts/main}">
<head>	
<script th:inline="javascript">
$(function() {
	$("#uriLoadingSpinnerAuthor").hide();
	$("#uriLoadingFailureAuthor").hide();
	$("#uriLoadingFoundAuthor").hide();
	
	$("#uriLoadingFoundAuthor").popover();
	$("#uriLoadingFailureAuthor").popover();
	
	$("#uriLoadingSpinnerEditor").hide();
	$("#uriLoadingFailureEditor").hide();
	$("#uriLoadingFoundEditor").hide();
	
	$("#uriLoadingFoundEditor").popover();
	$("#uriLoadingFailureEditor").popover();
	
	$("#uriLoadingSpinnerCreator").hide();
	$("#uriLoadingFailureCreator").hide();
	$("#uriLoadingFoundCreator").hide();
	
	$("#uriLoadingFoundCreator").popover();
	$("#uriLoadingFailureCreator").popover();
	
	$("#submitForm").click(function(e) {
		constructPersonArray("author", "author", 0);
		constructPersonArray("editor", "editor", 0);
		var creatorSubmitCount = 0;
		$(".creator-row").each(function(idx, elem){
			var ele = $(elem).children().first();
			if(!(ele.attr("id")=="editor" || ele.attr("id")=="author")) {
				var roleCount = constructPersonArray("creator", ele.attr("id"), creatorSubmitCount);
				creatorSubmitCount = creatorSubmitCount + roleCount;
			}
		});
		
		createConceptTags();
	});
	
	/* Handle Author events */
	$("#addAuthorButton").click(function() {
		savePersonDetails("Author", "Author");
	});
	
	$("#addAuthorModalCancel").click(function() {
		$("#authorModal").modal('hide');
		resetPersonCreationModal("Author");
	});
	
	$(".edit-author").click(function(){
		var authorItem = $(this).parent();
		editPerson('Author', authorItem[0]);
	});
	
	$(".edit-author").css('cursor', 'pointer');
	
	$(".remove-author").click(removePerson);
	$(".remove-author").css('cursor', 'pointer');
	$(".remove-concept").click(removeConcept);
	$(".remove-concept").css('cursor', 'pointer');
	
	$("#addAuthorAffiliation").click(function() {
		var affiliationCopy = $("#authorAffiliationTemplate").clone();
		affiliationCopy.removeAttr("id");
		affiliationCopy.addClass("aff-info");
		affiliationCopy.find("input").val("");
		affiliationCopy.show();
		$("#authorAffiliations").append(affiliationCopy);
	});
	
	$("#authorIconContainer").on('click', ".popover #authorCreateAuthority", function() {
		var uri = $("#uriLoadingFoundAuthor").attr('data-authority-uri');
		$.post("<c:url value="/auth/authority/create" />?${_csrf.parameterName}=${_csrf.token}&uri=" + uri, function(data) {
			$("#authorCreateAuthority").hide();
			$("#uriAuthorLocalId").val(data['id']);
			$("#authorAuthorityUsed").html("Created new authority entry <i>" + data['name'] + "</i>.");
			$("#authorAuthorityCreationFeedback").html('<div class="text-success" style="margin-top:10px;">Authority entry has been created!</div>');
			showPersonNameInModal(data['name'], "Author");
			$("#uriLoadingFoundAuthor").popover('hide');
		});
	});
	
	$("#authorIconContainer").on('click', ".popover .foundAuthorities li a", function(event) {
		var authId = $(this).attr('data-authority-id');
		$("#uriAuthorLocalId").val(authId);
		$("#authorAuthorityUsed").html("Using stored authority entry <i>" + $(this).attr('data-authority-name') + "</i>.");
		showPersonNameInModal($(this).attr('data-authority-name'), "Author");
		$("#uriLoadingFoundAuthor").popover('hide');
		event.preventDefault();
	});
	
	var timer = null;
	$("#uriAuthor").change(function() {
		resetPersonAuthorityCreation("Author");
		$("#uriLoadingSpinnerAuthor").show();
		var uri = $("#uriAuthor").val();
		clearTimeout(timer); 
	    timer = setTimeout(function() {
	    	getPersonAuthority(uri, "Author");
	    }, 1000);
	});
	
	/* Handle editor events */
	$(".edit-editor").click(function(){
		var editorItem = $(this).parent();
		editPerson('Editor', editorItem[0]);
	});
	
	$(".edit-editor").css('cursor', 'pointer');
	
	$("#addEditorButton").click(function() {
		savePersonDetails('Editor', 'Editor');
	});

	$("#addEditorModalCancel").click(function() {
		$("#editorModal").modal('hide');
		resetPersonCreationModal("Editor");
	});
	
	$(".remove-editor").click(removePerson);
	$(".remove-editor").css('cursor', 'pointer');
	
	$("#addEditorAffiliation").click(function() {
		var affiliationCopy = $("#editorAffiliationTemplate").clone();
		affiliationCopy.removeAttr("id");
		affiliationCopy.addClass("aff-info");
		affiliationCopy.find("input").val("");
		affiliationCopy.show();
		$("#editorAffiliations").append(affiliationCopy);
	});
	
	$("#uriEditor").change(function() {
		resetPersonAuthorityCreation("Editor");
		$("#uriLoadingSpinnerEditor").show();
		var uri = $("#uriEditor").val();
		clearTimeout(timer); 
	    timer = setTimeout(function() {
	    	getPersonAuthority(uri, "Editor");
	    }, 1000);
	});
	
	$("#editorIconContainer").on('click', ".popover #editorCreateAuthority", function() {
		var uri = $("#uriLoadingFoundEditor").attr('data-authority-uri');
		$.post("<c:url value="/auth/authority/create" />?${_csrf.parameterName}=${_csrf.token}&uri=" + uri, function(data) {
			$("#editorCreateAuthority").hide();
			$("#uriEditorLocalId").val(data['id']);
			$("#editorAuthorityUsed").html("Created new authority entry <i>" + data['name'] + "</i>.");
			$("#editorAuthorityCreationFeedback").html('<div class="text-success" style="margin-top:10px;">Authority entry has been created!</div>');
			showPersonNameInModal(data['name'], "Editor");
			$("#uriLoadingFoundEditor").popover('hide');
		});
	});
	
	$("#editorIconContainer").on('click', ".popover .foundAuthorities li a", function(event) {
		var authId = $(this).attr('data-authority-id');
		$("#uriEditorLocalId").val(authId);
		$("#editorAuthorityUsed").html("Using stored authority entry <i>" + $(this).attr('data-authority-name') + "</i>.");
		showPersonNameInModal($(this).attr('data-authority-name'), "Editor");
		$("#uriLoadingFoundEditor").popover('hide');
		event.preventDefault();
	});
	
	/* Handle Other Creators events */
	$("#addCreatorButton").click(function(e) {
		var target = $(e.target);
		if(target.attr("data-creator-type") != null) {			
			savePersonDetails(target.attr("data-creator-type"), "Creator");
		} else {
			savePersonDetails("", "Creator");
		}
	});
	
	$(".creatorModalLink").click(function(e) {
		var target = $(e.target);
		var creatorType = target.attr("data-creator-type").charAt(0).toUpperCase() + target.attr("data-creator-type").slice(1);
		$("#creatorLabel").text("Enter "+creatorType+" Information");
		$("#addCreatorButton").text("Add "+creatorType);
		$("#addCreatorButton").attr("data-creator-type", target.attr("data-creator-type"));
	});
	
	$("#addCreatorModalCancel").click(function() {
		$("#creatorModal").modal('hide');
		resetPersonCreationModal("Creator");
	});
	
	$(".edit-creator").click(function(){
		var creatorItem = $(this).parent();
		editPerson('Creator', creatorItem[0]);
	});
	
	$(".edit-creator").css('cursor', 'pointer');
		
	$(".remove-creator").click(removePerson);
	$(".remove-creator").css('cursor', 'pointer');

	$("#addCreatorAffiliation").click(function() {
		var affiliationCopy = $("#creatorAffiliationTemplate").clone();
		affiliationCopy.removeAttr("id");
		affiliationCopy.addClass("aff-info");
		affiliationCopy.find("input").val("");
		affiliationCopy.show();
		$("#creatorAffiliations").append(affiliationCopy);
	});
	
	$("#uriCreator").change(function() {
		resetPersonAuthorityCreation("Creator");
		$("#uriLoadingSpinnerCreator").show();
		var uri = $("#uriCreator").val();
		clearTimeout(timer); 
	    timer = setTimeout(function() {
	    	getPersonAuthority(uri, "Creator");
	    }, 1000);
	});
	
	$("#creatorIconContainer").on('click', ".popover #creatorCreateAuthority", function() {
		var uri = $("#uriLoadingFoundCreator").attr('data-authority-uri');
		$.post("<c:url value="/auth/authority/create" />?${_csrf.parameterName}=${_csrf.token}&uri=" + uri, function(data) {
			$("#creatorCreateAuthority").hide();
			$("#uriCreatorLocalId").val(data['id']);
			$("#creatorAuthorityUsed").html("Created new authority entry <i>" + data['name'] + "</i>.");
			$("#creatorAuthorityCreationFeedback").html('<div class="text-success" style="margin-top:10px;">Authority entry has been created!</div>');
			showPersonNameInModal(data['name'], "Creator");
			$("#uriLoadingFoundCreator").popover('hide');
		});
	});
	
	$("#creatorIconContainer").on('click', ".popover .foundAuthorities li a", function(event) {
		var authId = $(this).attr('data-authority-id');
		$("#uriCreatorLocalId").val(authId);
		$("#creatorAuthorityUsed").html("Using stored authority entry <i>" + $(this).attr('data-authority-name') + "</i>.");
		showPersonNameInModal($(this).attr('data-authority-name'), "Creator");
		$("#uriLoadingFoundCreator").popover('hide');
		event.preventDefault();
	});
	
	/* adding concepts */
	$("#addConceptButton").click(function(e) {
		e.preventDefault();
		
		var conceptId = $("#addConceptConceptSelect");
		var conceptType = $("#addConceptTypeSelect");
		
		var conceptSpan = $('<span class="badge"></span>');
		conceptSpan.attr("data-concept-uri", conceptId.val());
		conceptSpan.attr("data-type-uri", conceptType.val());
		
		var text = $("#addConceptConceptSelect option:selected").text();
		var typeName = $("#addConceptTypeSelect option:selected").text();
		conceptSpan.text(text + " | " + typeName + " ");
		var deleteIcon = $('<i class="fas fa-times remove-concept"></i>');
		deleteIcon.click(removeConcept);
		conceptSpan.append(deleteIcon);
		$("#conceptTags").append(conceptSpan);
		
		$("#addConceptModal").modal('hide');
	});
});

/* Function to populate name in modal fetched from uri */
function showPersonNameInModal(name, personType){
	var personName = name;
	
	/* Name containing brackets
	example: Dempsey, Hugh A. (Hugh Aylmer), 1929- */
	if(name.includes("(")) {
		personName = name.substring(0, name.indexOf("("));
	}
	
	/* Name containing title/year
	example: Iqbāl, Muḥammad, Sir, 1877-1938 */
	if(personName.split(",").length > 2) {
		personName = personName.substring(0, personName.indexOf(',', personName.indexOf(",")+1));
	}
	
	/* Name containing span
	example: Dempsey, Patrick, 1966- */
	if(personName.includes("-")) {
		personName = personName.trim();
		personName = personName.substring(0, personName.lastIndexOf(' '));
	}
	
	/* Name separated by comma
	example: Dempsey, Paul Stephen */
	if(personName.indexOf(",") != -1) {
		$("#firstName"+personType).val(personName.substring(personName.indexOf(',')+1).trim());
		$("#lastName"+personType).val(personName.substring(0, personName.lastIndexOf(', ')));
	} else {
		$("#lastName"+personType).val(personName.substring(personName.lastIndexOf(' ')+1).trim());
		$("#firstName"+personType).val(personName.substring(0, personName.lastIndexOf(' ')));
	}
}

/* Function to populate modal on edit */
function editPerson(modalName, item){
	var personItem = $(item);
	var modalNameLCase = modalName.toLowerCase();
	$("#firstName"+modalName).val(personItem.attr("data-"+modalNameLCase+"-firstname"));
	$("#lastName"+modalName).val(personItem.attr("data-"+modalNameLCase+"-lastname"));
	$("#uri"+modalName).val(personItem.attr("data-"+modalNameLCase+"-uri"));
	$("#id"+modalName).attr("data-"+modalNameLCase+"-id", personItem.attr("id"));
	
	personItem.children("span").each(function(idx, elem){
		var affInput = $("#"+modalNameLCase+"AffiliationTemplate").clone();
		affInput.removeAttr("id");
		affInput.addClass("aff-info");
		affInput.find("input").attr("data-affiliation-name", $(elem).data("affiliationName"));
		affInput.find("input").attr("data-affiliation-id", $(elem).data("affiliationId"));
		affInput.find("input").val($(elem).data("affiliationName"));
		$("#"+modalNameLCase+"Modal #"+modalNameLCase+"Affiliations").append(affInput);
	});
	
	if(personItem.children("span").length > 0) {
		$("#"+modalNameLCase+"AffiliationTemplate").hide();
	}
	$("#addCreatorButton").attr("data-"+modalNameLCase+"-type", personItem.attr("data-"+modalNameLCase+"type"));
	$("#add"+modalName+"Button").text("Update "+modalName);
	
	$("#"+modalNameLCase+"Modal").modal('show');
}

/* Function to save information on closing modal */
function savePersonDetails(personType, modalName){
	var modalNameLCase = modalName.toLowerCase();
	var personSpan;
	var personTypeLCase = personType.toLowerCase();
	if($("#id"+modalName).attr("data-"+modalNameLCase+"-id") != null && $("#id"+modalName).attr("data-"+modalNameLCase+"-id").length > 0) {
		personSpan = $('#'+$("#id"+modalName).attr("data-"+modalNameLCase+"-id"));
		personTypeLCase = personSpan.attr("data-creator-type").toLowerCase();
	} else {
		var id = personTypeLCase + $("."+personTypeLCase+"-item").length;
		personSpan = $('<span id="'+id+'">');
	}
	
	personSpan.attr("class", "label label-warning "+personTypeLCase +"-item");
	personSpan.html("");
	var firstname = $("#firstName"+modalName).val();
	var lastname = $("#lastName"+modalName).val();
	var uri = $("#uri"+modalName).val();
	var localAuthority = $("#"+modalName+"LocalId").val();
	
	personSpan.attr("data-"+modalNameLCase+"-firstname", firstname);
	personSpan.attr("data-"+modalNameLCase+"-lastname", lastname);
	personSpan.attr("data-"+modalNameLCase+"-uri", uri);
	personSpan.attr("data-"+modalNameLCase+"-authority-id", localAuthority);
	
	var affiliationsList = [];
	var affSpan = $("<span>");
	$("#"+modalNameLCase+"Affiliations").children().each(function(idx, elem) {
		var input = $(elem).find("input");
		if(input.val().length!=0){
			var affSpan = $("<span>");
			affSpan.attr("data-affiliation-name", input.val());
			affiliationsList.push(input.val());
			personSpan.append(affSpan);
		}
	});
	
	var affiliationString = "";
	if (affiliationsList.length != 0) {
		affiliationString = " (" + $.grep(affiliationsList, Boolean).join(", ") + ")";
	}
	
	personSpan.append(lastname + ', ' + firstname + affiliationString + '&nbsp;&nbsp; ');
	var editIcon = $('<i class="far fa-edit edit-'+modalNameLCase+'"></i>')
	var deleteIcon = $('<i class="fas fa-times remove-'+modalNameLCase+'"></i>');
	editIcon.click(function(){
		var personItem = $(this).parent();
		editPerson(modalName, personItem[0]);
	});
	deleteIcon.click(removePerson);
	personSpan.append(editIcon);
	personSpan.append(deleteIcon);
	$("#"+personTypeLCase+"List").append(personSpan);
	$("#"+personTypeLCase+"List").append("&nbsp;&nbsp; ");
	$("#"+modalNameLCase+"Modal").modal('hide');
	resetPersonCreationModal(modalName);
}


/* Function to append final information for form submission */
function constructPersonArray(arrayName, role, iter){
	var creator, otherCreatorCount = 0;
	var roleLC = role.toLowerCase();
	if(arrayName == "creator"){
		creator = "otherCreator";
	} else {
		creator = arrayName;
	}
	$('.'+roleLC+'-item').each(function(idx, person) {
		var creatorSubmitCount = idx + iter;
		var personIdField = $("<input>");
		personIdField.attr("type", "hidden");
		personIdField.attr("id", creator+"s" + creatorSubmitCount + ".id");
		personIdField.attr("name", creator+"s[" + creatorSubmitCount + "].id");
		personIdField.attr("value", $(person).attr("data-"+arrayName+"-id"));
		$("#editForm").append(personIdField);
		
		var personFirstNameField = $("<input>");
		personFirstNameField.attr("type", "hidden");
		personFirstNameField.attr("id", creator+"s" + creatorSubmitCount + ".firstName");
		personFirstNameField.attr("name", creator+"s[" + creatorSubmitCount + "].firstName");
		personFirstNameField.attr("value", $(person).attr("data-"+arrayName+"-firstname"));
		$("#editForm").append(personFirstNameField);
		
		var personLastNameField = $("<input>");
		personLastNameField.attr("type", "hidden");
		personLastNameField.attr("id", creator+"s" + creatorSubmitCount + ".lastName");
		personLastNameField.attr("name", creator+"s[" + creatorSubmitCount + "].lastName");
		personLastNameField.attr("value", $(person).attr("data-"+arrayName+"-lastname"));
		$("#editForm").append(personLastNameField);
		
		var personRoleField = $("<input>");
		personRoleField.attr("type", "hidden");
		personRoleField.attr("id", creator+"s" + creatorSubmitCount + ".role");
		personRoleField.attr("name", creator+"s[" + creatorSubmitCount + "].role");
		personRoleField.attr("value", role);
		$("#editForm").append(personRoleField);
		
		var personUriField = $("<input>");
		personUriField.attr("type", "hidden");
		personUriField.attr("id", creator+"s" + creatorSubmitCount + ".uri");
		personUriField.attr("name", creator+"s[" + creatorSubmitCount + "].uri");
		personUriField.attr("value", $(person).attr("data-"+arrayName+"-uri"));
		$("#editForm").append(personUriField);
		
		var personAuthorityField = $("<input>");
		personAuthorityField.attr("type", "hidden");
		personAuthorityField.attr("id", creator+"s" + creatorSubmitCount + ".localAuthorityId");
		personAuthorityField.attr("name", creator+"s[" + creatorSubmitCount + "].localAuthorityId");
		personAuthorityField.attr("value", $(person).attr("data-"+arrayName+"-authority-id"));
		$("#editForm").append(personAuthorityField);
		
		$(person).children("span").each(function(idx2, affiliation) {
			var affiliationField = $("<input>");
			affiliationField.attr("type", "hidden");
			affiliationField.attr("id", creator+"s" + creatorSubmitCount + ".affiliations" + idx2 + ".name");
			affiliationField.attr("name", creator+"s[" + creatorSubmitCount + "].affiliations[" + idx2 + "].name");
			affiliationField.attr("value", $(affiliation).attr("data-affiliation-name"));
			$("#editForm").append(affiliationField);
			
			var affiliationIdField = $("<input>");
			affiliationIdField.attr("type", "hidden");
			affiliationIdField.attr("id", creator+"s" + creatorSubmitCount + ".affiliations" + idx2 + ".id");
			affiliationIdField.attr("name", creator+"s[" + creatorSubmitCount + "].affiliations[" + idx2 + "].id");
			affiliationIdField.attr("value", $(affiliation).attr("data-affiliation-id"));
			$("#editForm").append(affiliationIdField);
		});
		otherCreatorCount += 1;
	});
	return otherCreatorCount;
}

function createConceptTags() {
	$("#conceptTags").children("span").each(function (idx, tag) {
		var conceptTagInput = $("<input>");
		conceptTagInput.attr("type", "hidden");
		conceptTagInput.attr("id", "conceptTags" + idx + ".conceptId");
		conceptTagInput.attr("name", "conceptTags[" + idx + "].conceptId");
		conceptTagInput.attr("value", $(tag).attr("data-concept-id"));
		$("#editForm").append(conceptTagInput);
		
		var conceptTagTypeInput = $("<input>");
		conceptTagTypeInput.attr("type", "hidden");
		conceptTagTypeInput.attr("id", "conceptTags" + idx + ".conceptTypeId");
		conceptTagTypeInput.attr("name", "conceptTags[" + idx + "].conceptTypeId");
		conceptTagTypeInput.attr("value", $(tag).attr("data-concept-type-id"));
		$("#editForm").append(conceptTagTypeInput);
		
		var conceptTagUri = $("<input>");
		conceptTagUri.attr("type", "hidden");
		conceptTagUri.attr("id", "conceptTags" + idx + ".conceptUri");
		conceptTagUri.attr("name", "conceptTags[" + idx + "].conceptUri");
		conceptTagUri.attr("value", $(tag).attr("data-concept-uri"));
		$("#editForm").append(conceptTagUri);
		
		var conceptTagName = $("<input>");
		conceptTagName.attr("type", "hidden");
		conceptTagName.attr("id", "conceptTags" + idx + ".conceptName");
		conceptTagName.attr("name", "conceptTags[" + idx + "].conceptName");
		conceptTagName.attr("value", $(tag).attr("data-concept-name"));
		$("#editForm").append(conceptTagName);
		
		var conceptTagType = $("<input>");
		conceptTagType.attr("type", "hidden");
		conceptTagType.attr("id", "conceptTags" + idx + ".conceptTypeName");
		conceptTagType.attr("name", "conceptTags[" + idx + "].conceptTypeName");
		conceptTagType.attr("value", $(tag).attr("data-type-name"));
		$("#editForm").append(conceptTagType);
		
		var conceptTagTypeUri = $("<input>");
		conceptTagTypeUri.attr("type", "hidden");
		conceptTagTypeUri.attr("id", "conceptTags" + idx + ".conceptTypeUri");
		conceptTagTypeUri.attr("name", "conceptTags[" + idx + "].conceptTypeUri");
		conceptTagTypeUri.attr("value", $(tag).attr("data-type-uri"));
		$("#editForm").append(conceptTagTypeUri);
	});
}

function resetPersonCreationModal(modalType) {
	var modalNameLCase = modalType.toLowerCase();
	$("#firstName"+modalType).val("");
	$("#lastName"+modalType).val("");
	$("#id"+modalType).attr("data-"+modalType+"-id", "");
	var affTemplate = $("#"+modalNameLCase+"AffiliationTemplate");
	$("#"+modalNameLCase+"Affiliations").children().remove();
	$("#"+modalNameLCase+"Affiliations").append(affTemplate);
	$("#"+modalNameLCase+"AffiliationTemplate").find("input").val("");
	$("#"+modalNameLCase+"AffiliationTemplate").show();
	$(".aff-info").remove();
	$("#uri"+modalType).val("");
	if(modalType == "Creator") {
		$("#addCreatorButton").attr("data-creator-type", "");
		$("#creatorLabel").text("Enter Creator Information");
		$("#addCreatorButton").text("Add Creator");
	}
	
	$("#add"+modalType+"Button").text("Add "+modalType);
	resetPersonAuthorityCreation(modalType);
}

function resetPersonAuthorityCreation(personType) {
	$("#uriLoadingFound"+personType).hide();
	$("#uriLoadingFailure"+personType).hide();
	$("#uriLoadingSpinner"+personType).hide();
	$("#uriLoadingFound"+personType).popover('hide');
	$("#uriLoadingFailure"+personType).popover('hide');
	$("#"+personType.toLowerCase()+"AuthorityUsed").html("");
	$("#"+personType.toLowerCase()+"AuthorityCreationFeedback").html("");
	$("#"+personType.toLowerCase()+"AuthorityCreationFeedback").hide();
}

function getPersonAuthority(uri, personType) {
	personType_lowerCase = personType.toLowerCase();
	$.get('<c:url value="/auth/authority/get?uri=" />' + uri + '&zoteroGroupId=' + ${zoteroGroupId}, function(data) {
		$("#uriLoadingFound"+personType).attr("data-authority-uri", data['uri']);
		var content = "Authority <b>" + uri + "</b>";
		if (data['userAuthorityEntries'] != null && data['userAuthorityEntries'].length > 0) {
			content += "<br><br>This authority entry has already been imported by you:";
			content += '<ul class="foundAuthorities">';
			data['userAuthorityEntries'].forEach(function(elem) {
				content += '<li>' + elem['name'];
				content += ' [<a href="" data-authority-id="' + elem['id'] + '" data-authority-name="' + elem['name'] + '">Use this one</a>]';
				content += '</li>';
			});
			content += "</ul>";
		}
		if (data['datasetAuthorityEntries'] != null && data['datasetAuthorityEntries'].length > 0) {
			content += "<br><br>This authority entry has already been imported by someone else for this dataset:";
			content += '<ul class="foundAuthorities">';
			data['datasetAuthorityEntries'].forEach(function(elem) {
				content += '<li>' + elem['name'];
				content += ' [<a href="" data-authority-id="' + elem['id'] + '" data-authority-name="' + elem['name'] + '">Use this one</a>]';
				content += '</li>';
			});
			content += "</ul>";
		}
		content += "<br><br>Do you want to create a managed authority entry?<br>" +
					'<span id="'+personType_lowerCase+'AuthorityCreationFeedback"><button id="'+personType_lowerCase+'CreateAuthority" type="submit" class="btn btn-link pull-right"><b>Yes, create a new entry!</b></button></span>';
		$("#uriLoadingFound"+personType).attr("data-content", content);
		$("#uriLoadingFound"+personType).attr("data-authority-uri", uri);
		$("#uriLoadingFound"+personType).show();
		$("#uriLoadingFound"+personType).popover('show');
	})
	.fail(function() {
		$("#uriLoadingFailure"+personType).show();
	 })
    .always(function() {
    	$("#uriLoadingSpinner"+personType).hide();
	 });

}

let removePerson = function removePerson(e) {
	var deleteIcon = e.currentTarget;
	var person = $(deleteIcon).parent();
	person.remove();
}

let removeConcept = function removeConcept(e) {
	var deleteIcon = e.currentTarget;
	var concept = $(deleteIcon).parent();
	concept.remove();
}
</script>
</head>
<body>
<div layout:fragment="content">
	<ol class="breadcrumb">
		<li><a th:href="@{/}">Home</a></li>
		<li><a th:href="@{|/auth/group/${zoteroGroupId}/items|}">Group</a></li>
		<li class="active">[[${citation.key}]]</li>
	</ol>
	
	<h2>
		<th:block th:each="author,status : ${citation.authors}">
			<strong>[[${author.lastName}]]<span th:if="${!#strings.isEmpty(author.firstName)}">, [[${author.firstName}]]</span></strong>
			<span th:if="${!status.last}">; </span>
		</th:block>
		<th:block th:each="editor,status : ${citation.editors}">
			<strong>[[${editor.lastName}]]<span th:if="${!#strings.isEmpty(editor.firstName)}">, [[${editor.firstName}]]</span></strong>
			<span th:if="${!status.last}">; </span>
		</th:block>
		<em>[[${citation.title}]]</em>
		<span th:if="${!#strings.isEmpty(citation.dateFreetext)}">
	 	  [[(${citation.dateFreetext})]]
	 	</span>
	</h2>

	<div class="modal fade" id="messageModal" tabindex="-1" role="dialog">
		<div class="modal-dialog">
			<div class="modal-content">
				<div id="displayMessage" class="modal-body"></div>
			</div>
		</div>
	</div>
	
	<span th:if="${!#strings.isEmpty(citation.key)}">
		<div th:with = "processingUrl = @{|${citation.key}/edit?index=${index}&page=${page}&sortBy=${sortBy}&collectionId=${collectionId}|}"></div>
	</span>
	
	<span th:if="${#strings.isEmpty(citation.key)}">
		<div th:with = "processingUrl = @{|/auth/group/${zoteroGroupId}/items/create|}"></div>
	</span>
	
	<form action="#" th:action="${processingUrl}" th:object="${form}" method="POST" id="editForm">
		<table class="table table-striped">
			<tr th:if = "${#strings.isEmpty(citation.key)}">
				<td width="20%">Collection</td>
				<td>
					<select class="form-control" th:field="*{collectionId}" >
     					<option th:value="">&nbsp;</option>
     					<option th:each = "citationCollection: ${citationCollections}" 
     							th:value="${citationCollection.key}" 
     							th:text="${citationCollection.name}" items="${citationCollections}" />
					<select>
				</td>
			</tr>
			
			<tr>
				<td width="20%">Citation Type</td>
				<td>
					<div th:with= "enumValues = ${edu.asu.diging.citesphere.model.bib.ItemType.values()}"/>
					<select id="items" th:field="*{itemType}" data-show-icon="true" class="form-control selectpicker">
						<th:block th:each="enumValue : &{enumValues}">
   						 	<div th:with="iconLabel=${@iconsResource.getProperty(enumValue + '_label')}"/>	
   						 	<span th:if="${empty iconLabel}">
						 		<div th:with="iconLabel=${enumValue}"/>
						 	</span>
							<option th:value="${enumValue}"> 
								<span th:if="${enumValue == citation.itemType}"> 
									<div>selected</div>
								</span> 
    						${iconLabel}
    						</option>
						</th:block>
					<select>
				</td>
			</tr>
			
			
		</table>
	</form>
</div>

</body>
